rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    function isEdit() {
      return isAuthenticated() && (getUserData().role == 'edit' || isAdmin());
    }

    function isAuthor(authorId) {
      return isAuthenticated() && request.auth.uid == authorId;
    }

    function isGroupMember(groupId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/groups/$(groupId)).data.memberIds.hasAny([request.auth.uid]);
    }

    function isGroupOwner(groupId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/groups/$(groupId)).data.ownerId == request.auth.uid;
    }

    function isPublicGroup(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId)).data.type == 'public';
    }

    function isPrivateGroup(groupId) {
      return get(/databases/$(database)/documents/groups/$(groupId)).data.type == 'private';
    }

    // Recipes collection rules
    match /recipes/{recipeId} {
      // Share-link: anyone (including guests)
      allow read: if resource.data.shareId != null && resource.data.shareId != '';

      // Admin can read any recipe that has a groupId (including drafts)
      allow read: if isAdmin() && resource.data.groupId != null;

      // Public group, non-draft: any authenticated user
      allow read: if isAuthenticated() &&
                     resource.data.groupId != null &&
                     !resource.data.isPrivate &&
                     isPublicGroup(resource.data.groupId);

      // Private group, non-draft: authenticated group member
      allow read: if isAuthenticated() &&
                     resource.data.groupId != null &&
                     !resource.data.isPrivate &&
                     isPrivateGroup(resource.data.groupId) &&
                     isGroupMember(resource.data.groupId);

      // Create: admin or edit, groupId must be set
      allow create: if (isAdmin() || isEdit()) &&
                       request.resource.data.groupId != null;

      // Update: admin (all), edit (own)
      allow update: if isAdmin() ||
                       (isEdit() && isAuthor(resource.data.authorId));

      // Delete: only admin
      allow delete: if isAdmin();
    }

    // Menus collection rules
    match /menus/{menuId} {
      // Share-link: anyone (including guests)
      allow read: if resource.data.shareId != null && resource.data.shareId != '';

      // Non-draft: any authenticated user (isPrivate missing or false)
      allow read: if isAuthenticated() && (resource.data.isPrivate == null || resource.data.isPrivate == false);

      // Draft: admin (all), edit (own)
      allow read: if resource.data.isPrivate &&
                     (isAdmin() || (isEdit() && isAuthor(resource.data.authorId)));

      // Create: admin or edit
      allow create: if isAdmin() || isEdit();

      // Update: admin (all), edit (own)
      allow update: if isAdmin() ||
                       (isEdit() && isAuthor(resource.data.authorId));

      // Delete: admin (all), edit (own)
      allow delete: if isAdmin() ||
                       (isEdit() && isAuthor(resource.data.authorId));
    }

    // Groups collection rules
    match /groups/{groupId} {
      // Public groups: all authenticated users can read
      allow read: if isAuthenticated() && resource.data.type == 'public';

      // Private groups: admin (all), edit+read (member or owner)
      allow read: if resource.data.type == 'private' &&
                     (isAdmin() ||
                      ((isEdit() || (isAuthenticated() && getUserData().role == 'read')) &&
                       (resource.data.memberIds.hasAny([request.auth.uid]) ||
                        resource.data.ownerId == request.auth.uid)));

      // Create: admin always, edit if creating a private group
      allow create: if isAdmin() ||
                       (isEdit() && request.resource.data.type == 'private');

      // Update: admin (all), edit+read (own groups)
      allow update: if isAdmin() ||
                       ((isEdit() || (isAuthenticated() && getUserData().role == 'read')) &&
                        (resource.data.memberIds.hasAny([request.auth.uid]) ||
                         resource.data.ownerId == request.auth.uid));

      // Delete: admin (all), edit (own = group owner)
      allow delete: if isAdmin() ||
                       (isEdit() && resource.data.ownerId == request.auth.uid);
    }

    // Users collection rules
    match /users/{userId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // Admin or guest (for registration)
      allow create: if isAdmin() || !isAuthenticated();

      // Admin (all), or authenticated user (own profile)
      allow update: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);

      // Only admin can delete
      allow delete: if isAdmin();
    }

    // User favorites subcollection
    match /users/{userId}/favorites/{favoriteId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // User menu favorites subcollection
    match /users/{userId}/menuFavorites/{favoriteId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Settings collection
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // Custom lists collection
    match /customLists/{listId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // FAQs collection
    match /faqs/{faqId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // Shopping lists collection
    match /shoppingLists/{listId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isEdit();
      allow update: if isAdmin() || (isEdit() && isAuthor(resource.data.authorId));
      allow delete: if isAdmin();
    }

    // AI Scan rate limiting collection
    match /aiScanLimits/{limitId} {
      allow read: if isAdmin() || isEdit();
      allow create, update, delete: if isAdmin();
    }
  }
}
